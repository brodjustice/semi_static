= form_for @newsletter do |f|
  - if @newsletter.errors.any?
    #error_explanation
      %h2= "#{pluralize(@newsletter.errors.count, "error")} prohibited this newsletter from being saved:"
      %ul
        - @newsletter.errors.full_messages.each do |msg|
          %li= msg

  %style{:type => 'text/css'}
    = @newsletter.css
  #newsletter-wrapper
    %table.newsletter
      - if (b = SemiStatic::Banner.find_by_name(@newsletter.subtitle))
        %tr{:style => "border-bottom: 1px solid #a0a0a0;"}
          %td{:colspan => 2, :style => 'text-align: center;'}
            = image_tag(b.img(:original))
            %h3= [@newsletter.name, @newsletter.subtitle].join(' ')
      - else
        %tr{:style => "border-bottom: 1px solid #a0a0a0;"}
          %td
            #newsletter-logo= image_tag(SemiStatic::Engine.config.newsletter_logo || SemiStatic::Engine.config.logo_image)
          %td
            %h1= @newsletter.name
            %h2= @newsletter.subtitle
      - unless @newsletter.salutation_post_text.blank?
        %tr
          %td{:colspan => 2}
            %p
              = @newsletter.salutation_pre_text unless @newsletter.salutation_pre_text.blank?
              = salutation_name(@newsletter) + ','
            = simple_format(@newsletter.salutation_post_text) unless @newsletter.salutation_post_text.blank?
  
      - @newsletter.draft_entry_objects.each_slice(2) do |row| 
        %tr
          - row.each do |e|
            %td.nl_entry
              .controls
                .swap{:title => 'Automatically swap the image for another in the entry'}
                  = link_to 'â†”', semi_static.edit_newsletter_path(@newsletter, :swap_image => e.id), :remote => true
                .new{:title => 'Upload a new newsletter image'}
                  = link_to 'â–¡', semi_static.edit_newsletter_path(@newsletter, :newsletter_img => e.id), :remote => true
                .add{:title => 'Add a new entry after this one'}
                  = link_to '+', semi_static.edit_newsletter_path(@newsletter, :select_entry => e.id), :remote => true
              = link_to semi_static.edit_entry_path(e) do
                .img{:id => "entry_id_#{e.id}"}
                  = render :partial => 'image', :locals => {:e => e}
        %tr
          - row.each do |e|
            %td.titles
              .nutWrap
                .nutWrapInner
                  %h3= link_to e.title, semi_static.edit_entry_path(e)
                  - unless e.sub_title.blank?
                    %h4= link_to e.sub_title, semi_static.edit_entry_path(e)
    %table.newsletter{:style => 'width: 100%; border-top: 1px solid #c8c8c8; margin-top: 8px; background-color: #f8f8f8'}
      %tr.newsletter-footer
        %td
          &copy;
          = SemiStatic::Engine.config.copyright_year
          = SemiStatic::Engine.config.copyright_owner
        %td
          = link_to t('Unsubscribe'), 'http://business-landing.com/'
      
  .mid
    .actions
      = f.submit 'Update'
      = f.submit 'Save and send draft newsletter', :name => 'email_draft'
      = f.submit 'Prepare to publish', :name => 'prepare'
